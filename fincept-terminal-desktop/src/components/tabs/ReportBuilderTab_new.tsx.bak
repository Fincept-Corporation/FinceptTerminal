import React, { useState } from 'react';
import {
  FileText,
  Download,
  Save,
  Type,
  BarChart3,
  Table,
  Image as ImageIcon,
  Trash2,
  Copy,
  AlignLeft,
  Code,
  Minus,
  FolderOpen,
  Check,
  Plus,
  RefreshCw,
  Edit2,
  Move,
  Columns as ColumnsIcon,
  Layout,
  BookOpen,
  FileX
} from 'lucide-react';
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';
import { arrayMove, SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { reportService, ReportTemplate, ReportComponent } from '@/services/reportService';
import { save, open } from '@tauri-apps/plugin-dialog';
import { toast } from 'sonner';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';

// Bloomberg color palette
const BLOOMBERG_COLORS = {
  ORANGE: '#FFA500',
  WHITE: '#FFFFFF',
  RED: '#ef4444',
  GREEN: '#10b981',
  YELLOW: '#fbbf24',
  GRAY: '#787878',
  BLUE: '#3b82f6',
  CYAN: '#06b6d4',
  DARK_BG: '#0a0a0a',
  PANEL_BG: '#1a1a1a',
  BORDER: '#333333',
};

// Sortable component wrapper
function SortableComponent({ component, onEdit, onDelete, onDuplicate, isSelected }: {
  component: ReportComponent;
  onEdit: (id: string) => void;
  onDelete: (id: string) => void;
  onDuplicate: (id: string) => void;
  isSelected: boolean;
}) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: component.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  const getComponentIcon = () => {
    switch (component.type) {
      case 'heading': return <Type size={10} />;
      case 'text': return <AlignLeft size={10} />;
      case 'chart': return <BarChart3 size={10} />;
      case 'table': return <Table size={10} />;
      case 'image': return <ImageIcon size={10} />;
      case 'code': return <Code size={10} />;
      case 'divider': return <Minus size={10} />;
      default: return <FileText size={10} />;
    }
  };

  return (
    <div
      ref={setNodeRef}
      style={{
        ...style,
        backgroundColor: isSelected ? '#2a2a2a' : 'transparent',
        borderBottom: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
        padding: '6px 8px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        cursor: 'pointer',
        borderLeft: isSelected ? `2px solid ${BLOOMBERG_COLORS.ORANGE}` : 'none'
      }}
    >
      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
        <div {...attributes} {...listeners} style={{ color: BLOOMBERG_COLORS.GRAY, cursor: 'move', display: 'flex' }}>
          <Move size={12} />
        </div>
        <div style={{ color: BLOOMBERG_COLORS.CYAN, display: 'flex' }}>
          {getComponentIcon()}
        </div>
        <span style={{ color: BLOOMBERG_COLORS.ORANGE, fontSize: '9px', fontWeight: 'bold' }}>
          {component.type.toUpperCase()}
        </span>
        <span style={{ color: BLOOMBERG_COLORS.GRAY, fontSize: '9px', flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
          {component.content ? component.content.substring(0, 20) : 'Empty'}
        </span>
      </div>
      <div style={{ display: 'flex', gap: '4px' }}>
        <button
          onClick={(e) => { e.stopPropagation(); onEdit(component.id); }}
          style={{
            background: 'transparent',
            border: 'none',
            color: BLOOMBERG_COLORS.BLUE,
            cursor: 'pointer',
            padding: '2px',
            display: 'flex'
          }}
          title="Edit"
        >
          <Edit2 size={10} />
        </button>
        <button
          onClick={(e) => { e.stopPropagation(); onDuplicate(component.id); }}
          style={{
            background: 'transparent',
            border: 'none',
            color: BLOOMBERG_COLORS.GREEN,
            cursor: 'pointer',
            padding: '2px',
            display: 'flex'
          }}
          title="Duplicate"
        >
          <Copy size={10} />
        </button>
        <button
          onClick={(e) => { e.stopPropagation(); onDelete(component.id); }}
          style={{
            background: 'transparent',
            border: 'none',
            color: BLOOMBERG_COLORS.RED,
            cursor: 'pointer',
            padding: '2px',
            display: 'flex'
          }}
          title="Delete"
        >
          <Trash2 size={10} />
        </button>
      </div>
    </div>
  );
}

const ReportBuilderTab: React.FC = () => {
  const [currentTime, setCurrentTime] = useState(new Date());
  const [template, setTemplate] = useState<ReportTemplate>({
    id: `report-${Date.now()}`,
    name: 'New Financial Report',
    description: 'Professional financial research report',
    components: [],
    metadata: {
      author: '',
      company: '',
      date: new Date().toISOString().split('T')[0],
      title: 'Financial Research Report',
    },
    styles: {
      pageSize: 'A4',
      orientation: 'portrait',
      margins: '20mm',
      headerFooter: true,
    },
  });

  const [selectedComponent, setSelectedComponent] = useState<string | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [showSuccessDialog, setShowSuccessDialog] = useState(false);
  const [generatedPdfPath, setGeneratedPdfPath] = useState<string>('');

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  // Update time
  React.useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

