import React, { useState } from 'react';
import {
  FileText,
  Download,
  Save,
  Type,
  BarChart3,
  Table,
  Image as ImageIcon,
  Trash2,
  Copy,
  AlignLeft,
  Code,
  Minus,
  FolderOpen,
  Check,
  Plus,
  RefreshCw,
  Edit2,
  Move,
  Columns as ColumnsIcon,
  Layout,
  BookOpen,
  FileX
} from 'lucide-react';
import { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';
import { arrayMove, SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { reportService, ReportTemplate, ReportComponent } from '@/services/reportService';
import { save, open } from '@tauri-apps/plugin-dialog';
import { toast } from 'sonner';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';

// Bloomberg color palette
const BLOOMBERG_COLORS = {
  ORANGE: '#FFA500',
  WHITE: '#FFFFFF',
  RED: '#ef4444',
  GREEN: '#10b981',
  YELLOW: '#fbbf24',
  GRAY: '#787878',
  BLUE: '#3b82f6',
  CYAN: '#06b6d4',
  DARK_BG: '#0a0a0a',
  PANEL_BG: '#1a1a1a',
  BORDER: '#333333',
};

// Sortable component wrapper
function SortableComponent({ component, onEdit, onDelete, onDuplicate, isSelected }: {
  component: ReportComponent;
  onEdit: (id: string) => void;
  onDelete: (id: string) => void;
  onDuplicate: (id: string) => void;
  isSelected: boolean;
}) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
  } = useSortable({ id: component.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  const getComponentIcon = () => {
    switch (component.type) {
      case 'heading': return <Type size={10} />;
      case 'text': return <AlignLeft size={10} />;
      case 'chart': return <BarChart3 size={10} />;
      case 'table': return <Table size={10} />;
      case 'image': return <ImageIcon size={10} />;
      case 'code': return <Code size={10} />;
      case 'divider': return <Minus size={10} />;
      default: return <FileText size={10} />;
    }
  };

  return (
    <div
      ref={setNodeRef}
      style={{
        ...style,
        backgroundColor: isSelected ? '#2a2a2a' : 'transparent',
        borderBottom: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
        padding: '6px 8px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        cursor: 'pointer',
        borderLeft: isSelected ? `2px solid ${BLOOMBERG_COLORS.ORANGE}` : 'none'
      }}
    >
      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
        <div {...attributes} {...listeners} style={{ color: BLOOMBERG_COLORS.GRAY, cursor: 'move', display: 'flex' }}>
          <Move size={12} />
        </div>
        <div style={{ color: BLOOMBERG_COLORS.CYAN, display: 'flex' }}>
          {getComponentIcon()}
        </div>
        <span style={{ color: BLOOMBERG_COLORS.ORANGE, fontSize: '9px', fontWeight: 'bold' }}>
          {component.type.toUpperCase()}
        </span>
        <span style={{ color: BLOOMBERG_COLORS.GRAY, fontSize: '9px', flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
          {component.content ? component.content.substring(0, 20) : 'Empty'}
        </span>
      </div>
      <div style={{ display: 'flex', gap: '4px' }}>
        <button
          onClick={(e) => { e.stopPropagation(); onEdit(component.id); }}
          style={{
            background: 'transparent',
            border: 'none',
            color: BLOOMBERG_COLORS.BLUE,
            cursor: 'pointer',
            padding: '2px',
            display: 'flex'
          }}
          title="Edit"
        >
          <Edit2 size={10} />
        </button>
        <button
          onClick={(e) => { e.stopPropagation(); onDuplicate(component.id); }}
          style={{
            background: 'transparent',
            border: 'none',
            color: BLOOMBERG_COLORS.GREEN,
            cursor: 'pointer',
            padding: '2px',
            display: 'flex'
          }}
          title="Duplicate"
        >
          <Copy size={10} />
        </button>
        <button
          onClick={(e) => { e.stopPropagation(); onDelete(component.id); }}
          style={{
            background: 'transparent',
            border: 'none',
            color: BLOOMBERG_COLORS.RED,
            cursor: 'pointer',
            padding: '2px',
            display: 'flex'
          }}
          title="Delete"
        >
          <Trash2 size={10} />
        </button>
      </div>
    </div>
  );
}

const ReportBuilderTab: React.FC = () => {
  const [currentTime, setCurrentTime] = useState(new Date());
  const [template, setTemplate] = useState<ReportTemplate>({
    id: `report-${Date.now()}`,
    name: 'New Financial Report',
    description: 'Professional financial research report',
    components: [],
    metadata: {
      author: '',
      company: '',
      date: new Date().toISOString().split('T')[0],
      title: 'Financial Research Report',
    },
    styles: {
      pageSize: 'A4',
      orientation: 'portrait',
      margins: '20mm',
      headerFooter: true,
    },
  });

  const [selectedComponent, setSelectedComponent] = useState<string | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [showSuccessDialog, setShowSuccessDialog] = useState(false);
  const [generatedPdfPath, setGeneratedPdfPath] = useState<string>('');

  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  // Update time
  React.useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  const addComponent = (type: ReportComponent['type']) => {
    const newComponent: ReportComponent = {
      id: `component-${Date.now()}`,
      type,
      content: type === 'divider' || type === 'pagebreak' || type === 'coverpage' ? null : '',
      config: {
        fontSize: type === 'heading' ? '2xl' : type === 'subheading' ? 'xl' : 'base',
        alignment: 'left',
        ...(type === 'columns' && { columnCount: 2 }),
        ...(type === 'section' && {
          sectionTitle: 'New Section',
          sectionStyle: 'default',
          backgroundColor: '#f8f9fa',
          borderColor: '#FFA500',
          padding: '15px'
        }),
        ...(type === 'coverpage' && {
          subtitle: '',
          backgroundColor: '#0a0a0a',
          color: '#FFA500'
        }),
      },
      ...(type === 'columns' || type === 'section' ? { children: [] } : {}),
    };

    setTemplate(prev => ({
      ...prev,
      components: [...prev.components, newComponent],
    }));
    setSelectedComponent(newComponent.id);
  };

  const deleteComponent = (id: string) => {
    setTemplate(prev => ({
      ...prev,
      components: prev.components.filter(c => c.id !== id),
    }));
    if (selectedComponent === id) {
      setSelectedComponent(null);
    }
  };

  const duplicateComponent = (id: string) => {
    const component = template.components.find(c => c.id === id);
    if (component) {
      const newComponent = {
        ...component,
        id: `component-${Date.now()}`,
      };
      setTemplate(prev => ({
        ...prev,
        components: [...prev.components, newComponent],
      }));
    }
  };

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      setTemplate(prev => {
        const oldIndex = prev.components.findIndex(c => c.id === active.id);
        const newIndex = prev.components.findIndex(c => c.id === over.id);

        return {
          ...prev,
          components: arrayMove(prev.components, oldIndex, newIndex),
        };
      });
    }
  };

  const updateComponent = (id: string, updates: Partial<ReportComponent>) => {
    setTemplate(prev => ({
      ...prev,
      components: prev.components.map(c =>
        c.id === id ? { ...c, ...updates } : c
      ),
    }));
  };

  const handleOpenFolder = async () => {
    try {
      const success = await reportService.openInFolder(generatedPdfPath);
      if (success) {
        toast.success('Folder opened');
      } else {
        toast.error('Failed to open folder');
      }
    } catch (error) {
      console.error('Failed to open folder:', error);
      toast.error('Failed to open folder');
    }
    setShowSuccessDialog(false);
  };

  const generatePDF = async () => {
    setIsGenerating(true);
    try {
      const outputPath = await save({
        filters: [{
          name: 'PDF',
          extensions: ['pdf']
        }],
        defaultPath: `${template.name.replace(/\s+/g, '-')}.pdf`
      });

      if (!outputPath) {
        setIsGenerating(false);
        return;
      }

      console.log('[ReportBuilder] Generating PDF at:', outputPath);
      const result = await reportService.generatePDF(template, outputPath);
      console.log('[ReportBuilder] PDF generation result:', result);

      if (result.success) {
        // Use the path returned by the service, or fall back to the selected path
        const finalPath = result.output_path || outputPath;
        console.log('[ReportBuilder] PDF saved to:', finalPath);
        setGeneratedPdfPath(finalPath);
        setShowSuccessDialog(true);
        toast.success('PDF generated successfully');
      } else {
        console.error('[ReportBuilder] PDF generation failed:', result.error);

        // Check if it's a missing dependency error
        if (result.error && result.error.includes('reportlab')) {
          toast.error('PDF Library Missing', {
            description: 'Please install: pip install reportlab',
            duration: 10000
          });
        } else {
          toast.error('Failed to generate PDF', {
            description: result.error || 'Unknown error'
          });
        }
      }
    } catch (error) {
      console.error('[ReportBuilder] Exception during PDF generation:', error);

      // Check if it's because the Rust command doesn't exist yet
      if (error instanceof Error && error.message.includes('not found')) {
        toast.error('PDF generation not implemented yet', {
          description: 'The backend PDF generation command is not available. Please implement the generate_report_pdf Rust command.'
        });
      } else {
        toast.error('Failed to generate PDF', {
          description: error instanceof Error ? error.message : 'Unknown error'
        });
      }
    } finally {
      setIsGenerating(false);
    }
  };

  const saveTemplate = async () => {
    setIsSaving(true);
    try {
      await reportService.saveTemplate(template);
      toast.success('Template saved');
    } catch (error) {
      console.error('Failed to save template:', error);
      toast.error('Failed to save template');
    } finally {
      setIsSaving(false);
    }
  };

  const selectedComp = selectedComponent
    ? template.components.find(c => c.id === selectedComponent)
    : null;

  return (
    <div style={{
      height: '100%',
      backgroundColor: BLOOMBERG_COLORS.DARK_BG,
      color: BLOOMBERG_COLORS.WHITE,
      fontFamily: 'Consolas, monospace',
      overflow: 'hidden',
      display: 'flex',
      flexDirection: 'column'
    }}>
      <style>{`
        *::-webkit-scrollbar { width: 8px; height: 8px; }
        *::-webkit-scrollbar-track { background: #1a1a1a; }
        *::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
        *::-webkit-scrollbar-thumb:hover { background: #525252; }
      `}</style>

      {/* Success Dialog */}
      <Dialog open={showSuccessDialog} onOpenChange={setShowSuccessDialog}>
        <DialogContent
          className="bg-gray-900 border-2 border-orange-500 text-white"
          style={{
            backgroundColor: BLOOMBERG_COLORS.PANEL_BG,
            borderColor: BLOOMBERG_COLORS.ORANGE,
            maxWidth: '600px'
          }}
        >
          <DialogHeader>
            <DialogTitle
              className="flex items-center gap-3 text-lg"
              style={{ color: BLOOMBERG_COLORS.ORANGE }}
            >
              <Check className="w-6 h-6" style={{ color: BLOOMBERG_COLORS.GREEN }} />
              PDF GENERATED SUCCESSFULLY
            </DialogTitle>
            <DialogDescription
              className="text-sm mt-2"
              style={{ color: BLOOMBERG_COLORS.GRAY }}
            >
              Your financial report has been exported successfully.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <div
              className="text-xs mb-2 uppercase font-bold"
              style={{ color: BLOOMBERG_COLORS.CYAN }}
            >
              FILE LOCATION:
            </div>
            <p
              className="text-sm break-all font-mono p-3 rounded"
              style={{
                backgroundColor: BLOOMBERG_COLORS.DARK_BG,
                border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                color: BLOOMBERG_COLORS.WHITE
              }}
            >
              {generatedPdfPath}
            </p>
          </div>
          <DialogFooter className="flex gap-3 justify-end">
            <button
              onClick={() => setShowSuccessDialog(false)}
              style={{
                background: BLOOMBERG_COLORS.GRAY,
                color: 'black',
                border: 'none',
                padding: '8px 16px',
                fontSize: '11px',
                fontWeight: 'bold',
                cursor: 'pointer',
                fontFamily: 'Consolas, monospace'
              }}
            >
              CLOSE
            </button>
            <button
              onClick={handleOpenFolder}
              style={{
                background: BLOOMBERG_COLORS.ORANGE,
                color: 'black',
                border: 'none',
                padding: '8px 16px',
                fontSize: '11px',
                fontWeight: 'bold',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
                fontFamily: 'Consolas, monospace'
              }}
            >
              <FolderOpen className="w-4 h-4" />
              SHOW IN FOLDER
            </button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Header Bar */}
      <div style={{
        backgroundColor: BLOOMBERG_COLORS.PANEL_BG,
        borderBottom: `1px solid ${BLOOMBERG_COLORS.GRAY}`,
        padding: '8px 12px',
        flexShrink: 0
      }}>
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
            <span style={{ color: BLOOMBERG_COLORS.ORANGE, fontWeight: 'bold', fontSize: '14px' }}>
              FINCEPT REPORT BUILDER
            </span>
            <span style={{ color: BLOOMBERG_COLORS.WHITE }}>|</span>
            <span style={{ color: BLOOMBERG_COLORS.GREEN, fontSize: '10px' }}>
              ‚óè ACTIVE
            </span>
            <span style={{ color: BLOOMBERG_COLORS.WHITE }}>|</span>
            <span style={{ color: BLOOMBERG_COLORS.CYAN, fontSize: '11px' }}>
              {currentTime.toISOString().replace('T', ' ').substring(0, 19)} UTC
            </span>
          </div>

          <div style={{ display: 'flex', gap: '8px' }}>
            <button
              onClick={() => {
                const equityTemplate = reportService.getEquityResearchTemplate();
                setTemplate(equityTemplate);
                toast.success('Loaded Equity Research template');
              }}
              style={{
                background: BLOOMBERG_COLORS.DARK_BG,
                color: BLOOMBERG_COLORS.CYAN,
                border: `1px solid ${BLOOMBERG_COLORS.CYAN}`,
                padding: '4px 12px',
                fontSize: '10px',
                fontWeight: 'bold',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '4px'
              }}
            >
              <FileText size={12} />
              LOAD TEMPLATE
            </button>
            <button
              onClick={saveTemplate}
              disabled={isSaving}
              style={{
                background: isSaving ? BLOOMBERG_COLORS.GRAY : BLOOMBERG_COLORS.CYAN,
                color: 'black',
                border: 'none',
                padding: '4px 12px',
                fontSize: '10px',
                fontWeight: 'bold',
                cursor: isSaving ? 'not-allowed' : 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '4px',
                opacity: isSaving ? 0.5 : 1
              }}
            >
              <Save size={12} />
              {isSaving ? 'SAVING...' : 'SAVE'}
            </button>
            <button
              onClick={generatePDF}
              disabled={isGenerating}
              style={{
                background: isGenerating ? BLOOMBERG_COLORS.GRAY : BLOOMBERG_COLORS.ORANGE,
                color: 'black',
                border: 'none',
                padding: '4px 12px',
                fontSize: '10px',
                fontWeight: 'bold',
                cursor: isGenerating ? 'not-allowed' : 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '4px',
                opacity: isGenerating ? 0.5 : 1
              }}
            >
              <Download size={12} />
              {isGenerating ? 'GENERATING...' : 'EXPORT PDF'}
            </button>
          </div>
        </div>
      </div>

      {/* Main Content Area */}
      <div style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
        {/* Left Panel - Component Palette & List */}
        <div style={{
          width: '280px',
          backgroundColor: BLOOMBERG_COLORS.PANEL_BG,
          borderRight: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
          display: 'flex',
          flexDirection: 'column'
        }}>
          {/* Report Metadata */}
          <div style={{
            borderBottom: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
            padding: '12px'
          }}>
            <div style={{ fontSize: '10px', color: BLOOMBERG_COLORS.ORANGE, fontWeight: 'bold', marginBottom: '8px' }}>
              REPORT METADATA
            </div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              <div>
                <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '2px' }}>
                  TITLE
                </label>
                <input
                  type="text"
                  value={template.metadata.title}
                  onChange={(e) => setTemplate(prev => ({
                    ...prev,
                    metadata: { ...prev.metadata, title: e.target.value }
                  }))}
                  style={{
                    width: '100%',
                    background: BLOOMBERG_COLORS.DARK_BG,
                    border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                    color: BLOOMBERG_COLORS.WHITE,
                    padding: '4px 6px',
                    fontSize: '10px',
                    fontFamily: 'Consolas, monospace'
                  }}
                />
              </div>
              <div>
                <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '2px' }}>
                  AUTHOR
                </label>
                <input
                  type="text"
                  value={template.metadata.author}
                  onChange={(e) => setTemplate(prev => ({
                    ...prev,
                    metadata: { ...prev.metadata, author: e.target.value }
                  }))}
                  style={{
                    width: '100%',
                    background: BLOOMBERG_COLORS.DARK_BG,
                    border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                    color: BLOOMBERG_COLORS.WHITE,
                    padding: '4px 6px',
                    fontSize: '10px',
                    fontFamily: 'Consolas, monospace'
                  }}
                />
              </div>
              <div>
                <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '2px' }}>
                  COMPANY
                </label>
                <input
                  type="text"
                  value={template.metadata.company}
                  onChange={(e) => setTemplate(prev => ({
                    ...prev,
                    metadata: { ...prev.metadata, company: e.target.value }
                  }))}
                  style={{
                    width: '100%',
                    background: BLOOMBERG_COLORS.DARK_BG,
                    border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                    color: BLOOMBERG_COLORS.WHITE,
                    padding: '4px 6px',
                    fontSize: '10px',
                    fontFamily: 'Consolas, monospace'
                  }}
                />
              </div>
            </div>
          </div>

          {/* Component Palette */}
          <div style={{
            borderBottom: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
            padding: '12px'
          }}>
            <div style={{ fontSize: '10px', color: BLOOMBERG_COLORS.ORANGE, fontWeight: 'bold', marginBottom: '8px' }}>
              CONTENT
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px', marginBottom: '12px' }}>
              <button
                onClick={() => addComponent('heading')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <Type size={14} />
                HEADING
              </button>
              <button
                onClick={() => addComponent('subheading')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <Type size={12} />
                SUBHEAD
              </button>
              <button
                onClick={() => addComponent('text')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <AlignLeft size={14} />
                TEXT
              </button>
              <button
                onClick={() => addComponent('image')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <ImageIcon size={14} />
                IMAGE
              </button>
              <button
                onClick={() => addComponent('chart')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <BarChart3 size={14} />
                CHART
              </button>
              <button
                onClick={() => addComponent('table')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <Table size={14} />
                TABLE
              </button>
              <button
                onClick={() => addComponent('code')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <Code size={14} />
                CODE
              </button>
              <button
                onClick={() => addComponent('divider')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.CYAN,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <Minus size={14} />
                DIVIDER
              </button>
            </div>

            <div style={{ fontSize: '10px', color: BLOOMBERG_COLORS.ORANGE, fontWeight: 'bold', marginBottom: '8px' }}>
              LAYOUT
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '6px', marginBottom: '12px' }}>
              <button
                onClick={() => addComponent('section')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.ORANGE,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <Layout size={14} />
                SECTION
              </button>
              <button
                onClick={() => addComponent('columns')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.ORANGE,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <ColumnsIcon size={14} />
                COLUMNS
              </button>
              <button
                onClick={() => addComponent('coverpage')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.ORANGE,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <BookOpen size={14} />
                COVER
              </button>
              <button
                onClick={() => addComponent('pagebreak')}
                style={{
                  background: BLOOMBERG_COLORS.DARK_BG,
                  border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                  color: BLOOMBERG_COLORS.ORANGE,
                  padding: '8px 4px',
                  fontSize: '9px',
                  fontWeight: 'bold',
                  cursor: 'pointer',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  gap: '4px'
                }}
              >
                <FileX size={14} />
                PAGE BREAK
              </button>
            </div>
          </div>

          {/* Component List */}
          <div style={{ flex: 1, overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
            <div style={{
              padding: '8px 12px',
              borderBottom: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
              fontSize: '10px',
              color: BLOOMBERG_COLORS.ORANGE,
              fontWeight: 'bold'
            }}>
              DOCUMENT STRUCTURE ({template.components.length})
            </div>
            <div style={{ flex: 1, overflow: 'auto' }}>
              {template.components.length === 0 ? (
                <div style={{
                  padding: '24px 12px',
                  textAlign: 'center',
                  fontSize: '9px',
                  color: BLOOMBERG_COLORS.GRAY
                }}>
                  <FileText size={32} style={{ margin: '0 auto 8px', opacity: 0.3 }} />
                  <div>NO COMPONENTS</div>
                  <div style={{ marginTop: '4px' }}>Add components above</div>
                </div>
              ) : (
                <DndContext
                  sensors={sensors}
                  collisionDetection={closestCenter}
                  onDragEnd={handleDragEnd}
                >
                  <SortableContext
                    items={template.components.map(c => c.id)}
                    strategy={verticalListSortingStrategy}
                  >
                    {template.components.map((component) => (
                      <SortableComponent
                        key={component.id}
                        component={component}
                        onEdit={setSelectedComponent}
                        onDelete={deleteComponent}
                        onDuplicate={duplicateComponent}
                        isSelected={selectedComponent === component.id}
                      />
                    ))}
                  </SortableContext>
                </DndContext>
              )}
            </div>
          </div>
        </div>

        {/* Main Panel - Visual Canvas */}
        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
          {/* Always show preview mode with inline editing */}
          <div style={{ flex: 1, overflow: 'auto', padding: '24px', backgroundColor: '#0d0d0d' }}>
            <div style={{
              maxWidth: '900px',
              margin: '0 auto',
              backgroundColor: '#ffffff',
              color: '#000000',
              padding: '48px',
              boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
              fontFamily: 'Georgia, serif'
            }}>
              {/* Report Header */}
              <div style={{
                borderBottom: '2px solid #000',
                paddingBottom: '16px',
                marginBottom: '24px'
              }}>
                <h1 style={{ fontSize: '28px', fontWeight: 'bold', marginBottom: '8px' }}>
                  {template.metadata.title}
                </h1>
                {template.metadata.company && (
                  <div style={{ fontSize: '16px', color: '#333', marginBottom: '8px' }}>
                    {template.metadata.company}
                  </div>
                )}
                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', color: '#666' }}>
                  {template.metadata.author && <span>Author: {template.metadata.author}</span>}
                  {template.metadata.date && <span>Date: {template.metadata.date}</span>}
                </div>
              </div>

              {/* Components - Click to Edit Inline */}
              {template.components.length === 0 ? (
                <div style={{
                  textAlign: 'center',
                  padding: '64px 24px',
                  color: '#999'
                }}>
                  <FileText size={64} style={{ margin: '0 auto 16px', opacity: 0.2 }} />
                  <div style={{ fontSize: '14px' }}>No components added yet</div>
                  <div style={{ fontSize: '12px', marginTop: '8px' }}>Add components from the left panel</div>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  {template.components.map((component) => {
                    const isEditing = selectedComponent === component.id;

                    return (
                      <div
                        key={component.id}
                        onClick={() => setSelectedComponent(component.id)}
                        style={{
                          cursor: 'pointer',
                          padding: isEditing ? '16px' : '12px',
                          borderRadius: '4px',
                          border: isEditing ? `3px solid ${BLOOMBERG_COLORS.ORANGE}` : '2px dashed transparent',
                          transition: 'all 0.2s',
                          backgroundColor: isEditing ? '#fff8f0' : 'transparent',
                          position: 'relative'
                        }}
                        onMouseEnter={(e) => {
                          if (!isEditing) {
                            e.currentTarget.style.backgroundColor = '#f9f9f9';
                            e.currentTarget.style.borderColor = '#ddd';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (!isEditing) {
                            e.currentTarget.style.backgroundColor = 'transparent';
                            e.currentTarget.style.borderColor = 'transparent';
                          }
                        }}
                      >
                        {/* Editing Toolbar */}
                        {isEditing && (
                          <div style={{
                            position: 'absolute',
                            top: '-32px',
                            right: '0',
                            display: 'flex',
                            gap: '4px',
                            backgroundColor: BLOOMBERG_COLORS.ORANGE,
                            padding: '4px 8px',
                            borderRadius: '4px 4px 0 0',
                            fontSize: '9px',
                            fontWeight: 'bold',
                            color: 'black'
                          }}>
                            <span>{component.type.toUpperCase()}</span>
                            <span>|</span>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                duplicateComponent(component.id);
                              }}
                              style={{
                                background: 'none',
                                border: 'none',
                                color: 'black',
                                cursor: 'pointer',
                                padding: '0 4px'
                              }}
                            >
                              COPY
                            </button>
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                deleteComponent(component.id);
                                setSelectedComponent(null);
                              }}
                              style={{
                                background: 'none',
                                border: 'none',
                                color: 'black',
                                cursor: 'pointer',
                                padding: '0 4px'
                              }}
                            >
                              DELETE
                            </button>
                          </div>
                        )}

                        {/* Inline Editor for Selected Component */}
                        {isEditing ? (
                          <div style={{
                            backgroundColor: 'white',
                            padding: '8px',
                            borderRadius: '4px'
                          }}>

                <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                  {(selectedComp.type === 'heading' || selectedComp.type === 'subheading' || selectedComp.type === 'text') && (
                    <>
                      <div>
                        <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                          CONTENT
                        </label>
                        <textarea
                          value={selectedComp.content}
                          onChange={(e) => updateComponent(selectedComp.id, { content: e.target.value })}
                          style={{
                            width: '100%',
                            background: BLOOMBERG_COLORS.DARK_BG,
                            border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                            color: BLOOMBERG_COLORS.WHITE,
                            padding: '8px',
                            fontSize: '11px',
                            fontFamily: 'Consolas, monospace',
                            minHeight: '120px',
                            resize: 'vertical'
                          }}
                          placeholder={`Enter ${selectedComp.type} content...`}
                        />
                      </div>
                      <div>
                        <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                          ALIGNMENT
                        </label>
                        <select
                          value={selectedComp.config.alignment}
                          onChange={(e) => updateComponent(selectedComp.id, {
                            config: { ...selectedComp.config, alignment: e.target.value as any }
                          })}
                          style={{
                            width: '100%',
                            background: BLOOMBERG_COLORS.DARK_BG,
                            border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                            color: BLOOMBERG_COLORS.WHITE,
                            padding: '6px 8px',
                            fontSize: '10px',
                            fontFamily: 'Consolas, monospace'
                          }}
                        >
                          <option value="left">LEFT</option>
                          <option value="center">CENTER</option>
                          <option value="right">RIGHT</option>
                        </select>
                      </div>
                    </>
                  )}

                  {selectedComp.type === 'chart' && (
                    <div>
                      <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                        CHART TYPE
                      </label>
                      <select
                        value={selectedComp.config.chartType || 'line'}
                        onChange={(e) => updateComponent(selectedComp.id, {
                          config: { ...selectedComp.config, chartType: e.target.value }
                        })}
                        style={{
                          width: '100%',
                          background: BLOOMBERG_COLORS.DARK_BG,
                          border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                          color: BLOOMBERG_COLORS.WHITE,
                          padding: '6px 8px',
                          fontSize: '10px',
                          fontFamily: 'Consolas, monospace'
                        }}
                      >
                        <option value="line">LINE CHART</option>
                        <option value="bar">BAR CHART</option>
                        <option value="pie">PIE CHART</option>
                        <option value="area">AREA CHART</option>
                      </select>
                      <div style={{
                        marginTop: '16px',
                        padding: '48px',
                        background: BLOOMBERG_COLORS.DARK_BG,
                        border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <BarChart3 size={64} style={{ color: BLOOMBERG_COLORS.CYAN, opacity: 0.3 }} />
                      </div>
                    </div>
                  )}

                  {selectedComp.type === 'code' && (
                    <div>
                      <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                        CODE BLOCK
                      </label>
                      <textarea
                        value={selectedComp.content}
                        onChange={(e) => updateComponent(selectedComp.id, { content: e.target.value })}
                        style={{
                          width: '100%',
                          background: BLOOMBERG_COLORS.DARK_BG,
                          border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                          color: BLOOMBERG_COLORS.GREEN,
                          padding: '12px',
                          fontSize: '10px',
                          fontFamily: 'Consolas, monospace',
                          minHeight: '240px',
                          resize: 'vertical'
                        }}
                        placeholder="Enter code here..."
                      />
                    </div>
                  )}

                  {selectedComp.type === 'table' && (
                    <div style={{
                      padding: '32px',
                      background: BLOOMBERG_COLORS.DARK_BG,
                      border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                      textAlign: 'center'
                    }}>
                      <Table size={48} style={{ color: BLOOMBERG_COLORS.CYAN, opacity: 0.3, margin: '0 auto' }} />
                      <div style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, marginTop: '12px' }}>
                        TABLE EDITOR COMING SOON
                      </div>
                    </div>
                  )}

                  {selectedComp.type === 'image' && (
                    <div>
                      <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                        IMAGE FILE
                      </label>
                      <div style={{
                        padding: '24px',
                        background: BLOOMBERG_COLORS.DARK_BG,
                        border: `1px dashed ${BLOOMBERG_COLORS.BORDER}`,
                        textAlign: 'center'
                      }}>
                        {selectedComp.config.imageUrl ? (
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            <div style={{
                              padding: '12px',
                              background: BLOOMBERG_COLORS.PANEL_BG,
                              border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                              borderRadius: '4px'
                            }}>
                              <div style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, marginBottom: '6px' }}>
                                SELECTED FILE:
                              </div>
                              <div style={{
                                fontSize: '10px',
                                color: BLOOMBERG_COLORS.WHITE,
                                fontFamily: 'Consolas, monospace',
                                wordBreak: 'break-all'
                              }}>
                                {selectedComp.config.imageUrl}
                              </div>
                            </div>
                            {selectedComp.config.imageUrl.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i) && (
                              <div style={{
                                maxWidth: '100%',
                                maxHeight: '300px',
                                overflow: 'hidden',
                                border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                                borderRadius: '4px'
                              }}>
                                <img
                                  src={`file://${selectedComp.config.imageUrl}`}
                                  alt="Preview"
                                  style={{
                                    maxWidth: '100%',
                                    maxHeight: '300px',
                                    objectFit: 'contain'
                                  }}
                                  onError={(e) => {
                                    (e.target as HTMLImageElement).style.display = 'none';
                                  }}
                                />
                              </div>
                            )}
                            <div style={{ display: 'flex', gap: '8px', justifyContent: 'center' }}>
                              <button
                                onClick={async () => {
                                  try {
                                    const selected = await open({
                                      multiple: false,
                                      filters: [{
                                        name: 'Images',
                                        extensions: ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp']
                                      }]
                                    });
                                    if (selected && typeof selected === 'string') {
                                      updateComponent(selectedComp.id, {
                                        config: { ...selectedComp.config, imageUrl: selected }
                                      });
                                      toast.success('Image updated successfully');
                                    }
                                  } catch (error) {
                                    console.error('Failed to select image:', error);
                                    toast.error('Failed to select image');
                                  }
                                }}
                                style={{
                                  background: BLOOMBERG_COLORS.CYAN,
                                  color: 'black',
                                  border: 'none',
                                  padding: '6px 12px',
                                  fontSize: '9px',
                                  fontWeight: 'bold',
                                  cursor: 'pointer',
                                  fontFamily: 'Consolas, monospace'
                                }}
                              >
                                CHANGE IMAGE
                              </button>
                              <button
                                onClick={() => {
                                  updateComponent(selectedComp.id, {
                                    config: { ...selectedComp.config, imageUrl: undefined }
                                  });
                                  toast.success('Image removed');
                                }}
                                style={{
                                  background: BLOOMBERG_COLORS.RED,
                                  color: 'white',
                                  border: 'none',
                                  padding: '6px 12px',
                                  fontSize: '9px',
                                  fontWeight: 'bold',
                                  cursor: 'pointer',
                                  fontFamily: 'Consolas, monospace'
                                }}
                              >
                                REMOVE
                              </button>
                            </div>
                          </div>
                        ) : (
                          <div>
                            <ImageIcon size={48} style={{ color: BLOOMBERG_COLORS.CYAN, opacity: 0.3, margin: '0 auto 12px' }} />
                            <div style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, marginBottom: '12px' }}>
                              NO IMAGE SELECTED
                            </div>
                            <button
                              onClick={async () => {
                                try {
                                  const selected = await open({
                                    multiple: false,
                                    filters: [{
                                      name: 'Images',
                                      extensions: ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp']
                                    }]
                                  });
                                  if (selected && typeof selected === 'string') {
                                    updateComponent(selectedComp.id, {
                                      config: { ...selectedComp.config, imageUrl: selected }
                                    });
                                    toast.success('Image selected successfully');
                                  }
                                } catch (error) {
                                  console.error('Failed to select image:', error);
                                  toast.error('Failed to select image');
                                }
                              }}
                              style={{
                                background: BLOOMBERG_COLORS.ORANGE,
                                color: 'black',
                                border: 'none',
                                padding: '8px 16px',
                                fontSize: '10px',
                                fontWeight: 'bold',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '6px',
                                margin: '0 auto',
                                fontFamily: 'Consolas, monospace'
                              }}
                            >
                              <Plus size={14} />
                              SELECT IMAGE FROM COMPUTER
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {selectedComp.type === 'divider' && (
                    <div style={{
                      padding: '16px',
                      background: BLOOMBERG_COLORS.DARK_BG,
                      border: `1px solid ${BLOOMBERG_COLORS.BORDER}`
                    }}>
                      <hr style={{ border: 'none', borderTop: `1px solid ${BLOOMBERG_COLORS.BORDER}` }} />
                    </div>
                  )}

                  {selectedComp.type === 'pagebreak' && (
                    <div style={{
                      padding: '24px',
                      background: BLOOMBERG_COLORS.DARK_BG,
                      border: `1px dashed ${BLOOMBERG_COLORS.BORDER}`,
                      textAlign: 'center'
                    }}>
                      <FileX size={48} style={{ color: BLOOMBERG_COLORS.ORANGE, opacity: 0.3, margin: '0 auto 12px' }} />
                      <div style={{ fontSize: '10px', color: BLOOMBERG_COLORS.GRAY }}>
                        PAGE BREAK - Starts new page in PDF
                      </div>
                    </div>
                  )}

                  {selectedComp.type === 'coverpage' && (
                    <div>
                      <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                        SUBTITLE
                      </label>
                      <input
                        type="text"
                        value={selectedComp.config.subtitle || ''}
                        onChange={(e) => updateComponent(selectedComp.id, {
                          config: { ...selectedComp.config, subtitle: e.target.value }
                        })}
                        style={{
                          width: '100%',
                          background: BLOOMBERG_COLORS.DARK_BG,
                          border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                          color: BLOOMBERG_COLORS.WHITE,
                          padding: '8px',
                          fontSize: '10px',
                          fontFamily: 'Consolas, monospace',
                          marginBottom: '12px'
                        }}
                        placeholder="Enter subtitle..."
                      />
                      <div style={{
                        padding: '48px',
                        background: selectedComp.config.backgroundColor || '#0a0a0a',
                        border: `2px solid ${BLOOMBERG_COLORS.ORANGE}`,
                        textAlign: 'center'
                      }}>
                        <BookOpen size={64} style={{ color: BLOOMBERG_COLORS.ORANGE, opacity: 0.5, margin: '0 auto 24px' }} />
                        <div style={{ fontSize: '24px', color: BLOOMBERG_COLORS.ORANGE, fontWeight: 'bold', marginBottom: '12px' }}>
                          COVER PAGE
                        </div>
                        <div style={{ fontSize: '12px', color: BLOOMBERG_COLORS.GRAY }}>
                          {selectedComp.config.subtitle || 'Subtitle here'}
                        </div>
                      </div>
                    </div>
                  )}

                  {selectedComp.type === 'section' && (
                    <div>
                      <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                        SECTION TITLE
                      </label>
                      <input
                        type="text"
                        value={selectedComp.config.sectionTitle || ''}
                        onChange={(e) => updateComponent(selectedComp.id, {
                          config: { ...selectedComp.config, sectionTitle: e.target.value }
                        })}
                        style={{
                          width: '100%',
                          background: BLOOMBERG_COLORS.DARK_BG,
                          border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                          color: BLOOMBERG_COLORS.WHITE,
                          padding: '8px',
                          fontSize: '10px',
                          fontFamily: 'Consolas, monospace',
                          marginBottom: '12px'
                        }}
                        placeholder="Enter section title..."
                      />
                      <div style={{
                        padding: selectedComp.config.padding || '15px',
                        background: selectedComp.config.backgroundColor || '#f8f9fa',
                        border: `3px solid ${selectedComp.config.borderColor || BLOOMBERG_COLORS.ORANGE}`
                      }}>
                        <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '8px', color: BLOOMBERG_COLORS.ORANGE }}>
                          {selectedComp.config.sectionTitle || 'SECTION TITLE'}
                        </div>
                        <div style={{ fontSize: '10px', color: BLOOMBERG_COLORS.GRAY }}>
                          Section content goes here. Add child components to populate this section.
                        </div>
                      </div>
                    </div>
                  )}

                  {selectedComp.type === 'columns' && (
                    <div>
                      <label style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, display: 'block', marginBottom: '6px' }}>
                        COLUMN COUNT
                      </label>
                      <select
                        value={selectedComp.config.columnCount || 2}
                        onChange={(e) => updateComponent(selectedComp.id, {
                          config: { ...selectedComp.config, columnCount: parseInt(e.target.value) as 2 | 3 }
                        })}
                        style={{
                          width: '100%',
                          background: BLOOMBERG_COLORS.DARK_BG,
                          border: `1px solid ${BLOOMBERG_COLORS.BORDER}`,
                          color: BLOOMBERG_COLORS.WHITE,
                          padding: '8px',
                          fontSize: '10px',
                          fontFamily: 'Consolas, monospace',
                          marginBottom: '12px'
                        }}
                      >
                        <option value="2">2 COLUMNS</option>
                        <option value="3">3 COLUMNS</option>
                      </select>
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: selectedComp.config.columnCount === 3 ? '1fr 1fr 1fr' : '1fr 1fr',
                        gap: '12px',
                        padding: '16px',
                        background: BLOOMBERG_COLORS.DARK_BG,
                        border: `1px solid ${BLOOMBERG_COLORS.BORDER}`
                      }}>
                        {[...Array(selectedComp.config.columnCount || 2)].map((_, i) => (
                          <div
                            key={i}
                            style={{
                              padding: '24px 12px',
                              border: `1px dashed ${BLOOMBERG_COLORS.BORDER}`,
                              textAlign: 'center',
                              fontSize: '9px',
                              color: BLOOMBERG_COLORS.GRAY
                            }}
                          >
                            COLUMN {i + 1}
                          </div>
                        ))}
                      </div>
                      <div style={{ fontSize: '9px', color: BLOOMBERG_COLORS.GRAY, marginTop: '12px' }}>
                        Add child components to populate columns
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ) : (
            // Preview Mode
            <div style={{ flex: 1, overflow: 'auto', padding: '24px', backgroundColor: '#0d0d0d' }}>
              <div style={{
                maxWidth: '900px',
                margin: '0 auto',
                backgroundColor: '#ffffff',
                color: '#000000',
                padding: '48px',
                boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                fontFamily: 'Georgia, serif'
              }}>
                {/* Report Header */}
                <div style={{
                  borderBottom: '2px solid #000',
                  paddingBottom: '16px',
                  marginBottom: '24px'
                }}>
                  <h1 style={{ fontSize: '28px', fontWeight: 'bold', marginBottom: '8px' }}>
                    {template.metadata.title}
                  </h1>
                  {template.metadata.company && (
                    <div style={{ fontSize: '16px', color: '#333', marginBottom: '8px' }}>
                      {template.metadata.company}
                    </div>
                  )}
                  <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', color: '#666' }}>
                    {template.metadata.author && <span>Author: {template.metadata.author}</span>}
                    {template.metadata.date && <span>Date: {template.metadata.date}</span>}
                  </div>
                </div>

                {/* Components */}
                {template.components.length === 0 ? (
                  <div style={{
                    textAlign: 'center',
                    padding: '64px 24px',
                    color: '#999'
                  }}>
                    <FileText size={64} style={{ margin: '0 auto 16px', opacity: 0.2 }} />
                    <div style={{ fontSize: '14px' }}>No components added yet</div>
                    <div style={{ fontSize: '12px', marginTop: '8px' }}>Add components from the left panel</div>
                  </div>
                ) : (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    {template.components.map((component) => (
                      <div
                        key={component.id}
                        onClick={() => setSelectedComponent(component.id)}
                        style={{
                          cursor: 'pointer',
                          padding: '12px',
                          borderRadius: '4px',
                          border: '1px solid transparent',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.backgroundColor = '#f9f9f9';
                          e.currentTarget.style.borderColor = BLOOMBERG_COLORS.CYAN;
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.backgroundColor = 'transparent';
                          e.currentTarget.style.borderColor = 'transparent';
                        }}
                      >
                        {component.type === 'coverpage' && (
                          <div style={{
                            minHeight: '400px',
                            backgroundColor: component.config.backgroundColor || '#0a0a0a',
                            border: `3px solid ${BLOOMBERG_COLORS.ORANGE}`,
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            padding: '48px',
                            textAlign: 'center'
                          }}>
                            <h1 style={{ fontSize: '32px', fontWeight: 'bold', color: BLOOMBERG_COLORS.ORANGE, marginBottom: '16px' }}>
                              {template.metadata.title}
                            </h1>
                            {component.config.subtitle && (
                              <div style={{ fontSize: '16px', color: BLOOMBERG_COLORS.GRAY, marginBottom: '32px' }}>
                                {component.config.subtitle}
                              </div>
                            )}
                            <div style={{ fontSize: '12px', color: BLOOMBERG_COLORS.GRAY, marginTop: '32px' }}>
                              {template.metadata.company}<br />
                              {template.metadata.date}
                            </div>
                          </div>
                        )}
                        {component.type === 'pagebreak' && (
                          <div style={{
                            padding: '24px',
                            border: '2px dashed #ddd',
                            textAlign: 'center',
                            backgroundColor: '#f9f9f9'
                          }}>
                            <FileX size={32} style={{ color: '#999', margin: '0 auto 8px' }} />
                            <div style={{ fontSize: '11px', color: '#999' }}>PAGE BREAK</div>
                          </div>
                        )}
                        {component.type === 'section' && (
                          <div style={{
                            padding: component.config.padding || '20px',
                            backgroundColor: component.config.backgroundColor || '#f8f9fa',
                            border: `3px solid ${component.config.borderColor || BLOOMBERG_COLORS.ORANGE}`,
                            borderRadius: '4px'
                          }}>
                            <h3 style={{
                              fontSize: '18px',
                              fontWeight: 'bold',
                              marginBottom: '12px',
                              color: component.config.borderColor || BLOOMBERG_COLORS.ORANGE
                            }}>
                              {component.config.sectionTitle || 'SECTION'}
                            </h3>
                            <div style={{ fontSize: '12px', color: '#666' }}>
                              {component.children && component.children.length > 0 ? (
                                <div>Child components: {component.children.length}</div>
                              ) : (
                                <div>No child components added yet</div>
                              )}
                            </div>
                          </div>
                        )}
                        {component.type === 'columns' && (
                          <div style={{
                            display: 'grid',
                            gridTemplateColumns: component.config.columnCount === 3 ? '1fr 1fr 1fr' : '1fr 1fr',
                            gap: '16px',
                            padding: '12px',
                            border: '1px solid #ddd',
                            borderRadius: '4px',
                            backgroundColor: '#fafafa'
                          }}>
                            {[...Array(component.config.columnCount || 2)].map((_, i) => (
                              <div
                                key={i}
                                style={{
                                  padding: '16px',
                                  border: '1px dashed #ccc',
                                  minHeight: '100px',
                                  backgroundColor: 'white'
                                }}
                              >
                                <div style={{ fontSize: '10px', color: '#999', textAlign: 'center' }}>
                                  Column {i + 1}
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                        {component.type === 'heading' && (
                          <h2 style={{ fontSize: '22px', fontWeight: 'bold' }}>
                            {component.content || 'Heading'}
                          </h2>
                        )}
                        {component.type === 'subheading' && (
                          <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#444' }}>
                            {component.content || 'Subheading'}
                          </h3>
                        )}
                        {component.type === 'text' && (
                          <p style={{ fontSize: '14px', lineHeight: '1.6' }}>
                            {component.content || 'Text content...'}
                          </p>
                        )}
                        {component.type === 'chart' && (
                          <div style={{
                            border: '1px solid #ddd',
                            borderRadius: '4px',
                            padding: '24px',
                            backgroundColor: '#f5f5f5',
                            textAlign: 'center'
                          }}>
                            <BarChart3 size={80} style={{ margin: '0 auto', color: '#3b82f6' }} />
                            <div style={{ fontSize: '12px', color: '#666', marginTop: '8px' }}>
                              {component.config.chartType || 'Chart'} Preview
                            </div>
                          </div>
                        )}
                        {component.type === 'table' && (
                          <div style={{ border: '1px solid #ddd', borderRadius: '4px', overflow: 'hidden' }}>
                            <table style={{ width: '100%', fontSize: '12px', borderCollapse: 'collapse' }}>
                              <thead style={{ backgroundColor: '#f0f0f0' }}>
                                <tr>
                                  {['Column 1', 'Column 2', 'Column 3'].map((col, i) => (
                                    <th key={i} style={{ padding: '8px 12px', textAlign: 'left', borderBottom: '1px solid #ddd' }}>
                                      {col}
                                    </th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td style={{ padding: '8px 12px' }}>Sample</td>
                                  <td style={{ padding: '8px 12px' }}>Sample</td>
                                  <td style={{ padding: '8px 12px' }}>Sample</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        )}
                        {component.type === 'image' && (
                          <div style={{
                            border: '1px solid #ddd',
                            borderRadius: '4px',
                            padding: component.config.imageUrl ? '12px' : '48px',
                            backgroundColor: '#f5f5f5',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                          }}>
                            {component.config.imageUrl ? (
                              <img
                                src={`file://${component.config.imageUrl}`}
                                alt="Report Image"
                                style={{
                                  maxWidth: '100%',
                                  maxHeight: '400px',
                                  objectFit: 'contain'
                                }}
                                onError={(e) => {
                                  const target = e.target as HTMLImageElement;
                                  target.style.display = 'none';
                                  const parent = target.parentElement;
                                  if (parent) {
                                    parent.innerHTML = '<div style="color: #999; text-align: center; padding: 24px;"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg><div style="margin-top: 12px; font-size: 14px;">Image not found</div></div>';
                                  }
                                }}
                              />
                            ) : (
                              <ImageIcon size={64} style={{ color: '#999' }} />
                            )}
                          </div>
                        )}
                        {component.type === 'code' && (
                          <pre style={{
                            backgroundColor: '#1a1a1a',
                            border: '1px solid #333',
                            borderRadius: '4px',
                            padding: '16px',
                            overflow: 'auto',
                            fontSize: '11px',
                            color: '#10b981',
                            fontFamily: 'Consolas, monospace'
                          }}>
                            <code>{component.content || '# Code block'}</code>
                          </pre>
                        )}
                        {component.type === 'divider' && (
                          <hr style={{ border: 'none', borderTop: '1px solid #ddd' }} />
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ReportBuilderTab;
