name: Build Artifacts Only

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Build macOS artifacts for testing (unsigned builds require xattr command)'
        required: false
        default: 'See artifact download instructions below'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-14'
            args: '--target aarch64-apple-darwin'
            os_name: 'macOS'
            arch: 'arm64'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-15-intel'
            args: '--target x86_64-apple-darwin'
            os_name: 'macOS'
            arch: 'x64'
            target: 'x86_64-apple-darwin'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './fincept-terminal-desktop/src-tauri -> target'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Verify project structure and resources
        run: |
          echo "Verifying project structure..."
          if [ ! -f "fincept-terminal-desktop/src-tauri/resources/requirements-numpy1.txt" ]; then
            echo "Error: requirements-numpy1.txt not found!"
            exit 1
          fi
          if [ ! -f "fincept-terminal-desktop/src-tauri/resources/requirements-numpy2.txt" ]; then
            echo "Error: requirements-numpy2.txt not found!"
            exit 1
          fi
          if [ ! -d "fincept-terminal-desktop/src-tauri/resources/scripts" ]; then
            echo "Error: scripts directory not found!"
            exit 1
          fi
          echo "Resources verified successfully"
        shell: bash

      - name: Install frontend dependencies
        run: bun install
        working-directory: ./fincept-terminal-desktop

      # NOTE: Python and Bun are NOT bundled in the app
      # They are downloaded and installed on first run via setup.rs
      # Only requirements.txt and scripts are bundled as resources
      # See: fincept-terminal-desktop/src-tauri/src/setup.rs for installation logic
      # See: fincept-terminal-desktop/src-tauri/src/utils/python.rs for runtime path resolution

      - name: Build the app with signing
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: fincept-terminal-desktop
          args: ${{ matrix.args }}
          includeUpdaterJson: true

      - name: Prepare artifacts with proper naming
        id: prepare
        run: |
          mkdir -p release-artifacts

          # Get version for consistent naming
          if [ -f "fincept-terminal-desktop/src-tauri/Cargo.toml" ]; then
            VERSION=$(grep '^version = ' fincept-terminal-desktop/src-tauri/Cargo.toml | head -n1 | cut -d '"' -f2)
          else
            VERSION="1.0.0"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # macOS builds only
          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            SUFFIX="macOS-arm64"
          else
            SUFFIX="macOS-x64"
          fi

          find fincept-terminal-desktop/src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" -exec cp {} release-artifacts/FinceptTerminal-v${VERSION}-${SUFFIX}.dmg \; 2>/dev/null && echo "[OK] Found .dmg" || echo "[WARN] No .dmg found"

          # List what we found
          echo "=== Release Artifacts ==="
          ls -la release-artifacts/ || echo "No artifacts prepared"

          # Set output for later steps
          artifact_count=$(find release-artifacts -type f | wc -l)
          echo "artifact_count=$artifact_count" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload build artifacts
        if: steps.prepare.outputs.artifact_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os_name }}-${{ matrix.arch }}
          path: release-artifacts/
          retention-days: 30

      - name: Installation Instructions
        if: steps.prepare.outputs.artifact_count > 0
        run: |
          cat << 'EOF'

          ========================================
          macOS Installation Instructions
          ========================================

          IMPORTANT: This is an UNSIGNED build

          After downloading the artifact:

          1. Extract the ZIP file
          2. Remove quarantine flag from DMG:

             xattr -cr ~/Downloads/FinceptTerminal-*.dmg

          3. Open DMG and drag app to Applications
          4. Remove quarantine flag from app:

             xattr -cr /Applications/FinceptTerminal.app

          5. Launch the app normally

          Alternative: Right-click app -> Open -> Open

          ========================================
          EOF
        shell: bash
