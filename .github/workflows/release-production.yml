name: Production Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            os_name: 'macOS'
            arch: 'arm64'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            os_name: 'macOS'
            arch: 'x64'
            target: 'x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: '--target x86_64-unknown-linux-gnu'
            os_name: 'Linux'
            arch: 'x64'
            target: 'x86_64-unknown-linux-gnu'
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            os_name: 'Windows'
            arch: 'x64'
            target: 'x86_64-pc-windows-msvc'

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libwebkit2gtk-4.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libjavascriptcoregtk-4.0-dev \
            libsoup-3.0-dev \
            libsoup2.4-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libnss3-dev \
            libxss1 \
            libasound2-dev

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './fincept-terminal-desktop/src-tauri -> target'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Verify project structure and resources
        run: |
          echo "Verifying project structure..."
          ls -la fincept-terminal-desktop/
          ls -la fincept-terminal-desktop/src-tauri/
          ls -la fincept-terminal-desktop/src-tauri/resources/
          echo "Checking requirements.txt exists..."
          if [ ! -f "fincept-terminal-desktop/src-tauri/resources/requirements.txt" ]; then
            echo "Error: requirements.txt not found!"
            exit 1
          fi
          echo "Checking scripts directory exists..."
          if [ ! -d "fincept-terminal-desktop/src-tauri/resources/scripts" ]; then
            echo "Error: scripts directory not found!"
            exit 1
          fi
          echo "Resources verified successfully"
        shell: bash

      - name: Install frontend dependencies
        run: bun install
        working-directory: ./fincept-terminal-desktop

      # NOTE: Python and Bun are NOT bundled in the app
      # They are downloaded and installed on first run via setup.rs
      # Only requirements.txt and scripts are bundled as resources
      # See: fincept-terminal-desktop/src-tauri/src/setup.rs for installation logic
      # See: fincept-terminal-desktop/src-tauri/src/utils/python.rs for runtime path resolution

      - name: Build the app with updater
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: fincept-terminal-desktop
          tagName: ${{ github.ref_name }}
          releaseName: 'FinceptTerminal ${{ github.ref_name }}'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
          includeUpdaterJson: true

      - name: Prepare artifacts with proper naming
        id: prepare
        run: |
          mkdir -p release-artifacts

          # Get version for consistent naming
          if [ -f "fincept-terminal-desktop/src-tauri/Cargo.toml" ]; then
            VERSION=$(grep '^version = ' fincept-terminal-desktop/src-tauri/Cargo.toml | head -n1 | cut -d '"' -f2)
          else
            VERSION="1.0.0"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Find and rename artifacts based on platform
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            # macOS builds
            if [[ "${{ matrix.arch }}" == "arm64" ]]; then
              SUFFIX="macOS-arm64"
            else
              SUFFIX="macOS-x64"
            fi

            find fincept-terminal-desktop/src-tauri/target/${{ matrix.target }}/release/bundle -name "*.dmg" -exec cp {} release-artifacts/FinceptTerminal-v${VERSION}-${SUFFIX}.dmg \; 2>/dev/null && echo "[OK] Found .dmg" || echo "[WARN] No .dmg found"

          elif [[ "${{ matrix.platform }}" == "ubuntu-22.04" ]]; then
            # Linux builds
            SUFFIX="Linux-x64"
            find fincept-terminal-desktop/src-tauri/target/${{ matrix.target }}/release/bundle -name "*.AppImage" -exec cp {} release-artifacts/FinceptTerminal-v${VERSION}-${SUFFIX}.AppImage \; 2>/dev/null && echo "[OK] Found .AppImage" || echo "[WARN] No .AppImage found"
            find fincept-terminal-desktop/src-tauri/target/${{ matrix.target }}/release/bundle -name "*.deb" -exec cp {} release-artifacts/FinceptTerminal-v${VERSION}-${SUFFIX}.deb \; 2>/dev/null && echo "[OK] Found .deb" || echo "[WARN] No .deb found"

          elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            # Windows builds
            SUFFIX="Windows-x64"
            find fincept-terminal-desktop/src-tauri/target/${{ matrix.target }}/release/bundle -name "*.msi" -exec cp {} release-artifacts/FinceptTerminal-v${VERSION}-${SUFFIX}.msi \; 2>/dev/null && echo "[OK] Found .msi" || echo "[WARN] No .msi found"
          fi

          # List what we found
          echo "=== Release Artifacts ==="
          ls -la release-artifacts/ || echo "No artifacts prepared"

          # Set output for later steps
          artifact_count=$(find release-artifacts -type f | wc -l)
          echo "artifact_count=$artifact_count" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload build artifacts
        if: steps.prepare.outputs.artifact_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os_name }}-${{ matrix.arch }}
          path: release-artifacts/
          retention-days: 90

  create-release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          if [ -f "fincept-terminal-desktop/src-tauri/Cargo.toml" ]; then
            VERSION=$(grep '^version = ' fincept-terminal-desktop/src-tauri/Cargo.toml | head -n1 | cut -d '"' -f2)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "version=1.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Organize release files
        id: organize
        run: |
          mkdir -p release-files

          # Move all files to release-files directory
          find all-artifacts -type f \( -name "*.dmg" -o -name "*.msi" -o -name "*.AppImage" -o -name "*.deb" \) -exec cp {} release-files/ \;

          # Also copy updater files (latest.json and .sig files)
          find all-artifacts -type f \( -name "latest.json" -o -name "*.tar.gz" -o -name "*.tar.gz.sig" -o -name "*.zip" -o -name "*.zip.sig" \) -exec cp {} release-files/ \; 2>/dev/null || true

          echo "=== Release Files ==="
          ls -la release-files/

          # Check if we have files
          file_count=$(find release-files -type f | wc -l)
          echo "file_count=$file_count" >> $GITHUB_OUTPUT

          # Create file list for release notes
          echo "FILES_LIST<<EOF" >> $GITHUB_OUTPUT
          ls -1 release-files/ >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create/Update Release
        if: steps.organize.outputs.file_count > 0
        id: create_release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG_NAME="${{ github.ref_name }}"
          RELEASE_NAME="FinceptTerminal ${TAG_NAME}"

          # Create release notes
          cat << EOF > release_notes.md
          # FinceptTerminal ${TAG_NAME}

          **Auto-Update Enabled** - This release includes automatic update support via Tauri updater.

          Built from commit \`${{ github.sha }}\`

          ## Downloads

          Choose the right version for your operating system:

          ### macOS
          - **Apple Silicon (M1/M2/M3)**: Download \`FinceptTerminal-v${VERSION}-macOS-arm64.dmg\`
          - **Intel**: Download \`FinceptTerminal-v${VERSION}-macOS-x64.dmg\`

          ### Linux
          - **AppImage (Universal)**: Download \`FinceptTerminal-v${VERSION}-Linux-x64.AppImage\`
          - **Debian/Ubuntu**: Download \`FinceptTerminal-v${VERSION}-Linux-x64.deb\`

          ### Windows
          - **Windows Installer**: Download \`FinceptTerminal-v${VERSION}-Windows-x64.msi\`

          ## Auto-Update

          This release includes Tauri's built-in auto-updater. Existing users will be notified of this update automatically.

          ## Installation Instructions

          - **macOS**: Open the .dmg file and drag FinceptTerminal to Applications
          - **Linux AppImage**: Make executable (\`chmod +x\`) and run
          - **Linux Debian**: Install with \`sudo dpkg -i filename.deb\`
          - **Windows**: Run the .msi installer

          ## Python & Bun Installation

          Python and Bun are **NOT** bundled with the app to keep download size small.
          On first launch, the app will:
          - Download Python 3.12 (embedded/standalone)
          - Download Bun 1.1.0 (optimized for your CPU)
          - Install required Python packages from requirements.txt

          This happens automatically and takes 2-5 minutes depending on your internet connection.

          ---

          **Files in this release:**
          \`\`\`
          ${{ steps.organize.outputs.FILES_LIST }}
          \`\`\`

          **Build Information:**
          - Commit: ${{ github.sha }}
          - Build Date: $(date -u +"%Y-%m-%d %H:%M UTC")
          - Workflow Run: [#${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          # Create or update release
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes-file release_notes.md \
            --latest \
            release-files/* || \
          gh release upload "$TAG_NAME" release-files/* --clobber

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README with direct download links
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG_NAME="${{ steps.create_release.outputs.tag_name }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          CURRENT_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}

          cat << EOF > download_section.md
          ## Download Latest Release

          **Version:** \`${TAG_NAME}\` | **Commit:** \`${SHORT_SHA}\` | **Released:** ${CURRENT_DATE}

          ### Direct Downloads - Click to Download Immediately

          | Platform | Architecture | Direct Download |
          |----------|-------------|----------------|
          | **macOS** | Apple Silicon (ARM64) | [Download .dmg](${REPO_URL}/releases/download/${TAG_NAME}/FinceptTerminal-v${VERSION}-macOS-arm64.dmg) |
          | **macOS** | Intel (x64) | [Download .dmg](${REPO_URL}/releases/download/${TAG_NAME}/FinceptTerminal-v${VERSION}-macOS-x64.dmg) |
          | **Linux** | x64 (AppImage) | [Download .AppImage](${REPO_URL}/releases/download/${TAG_NAME}/FinceptTerminal-v${VERSION}-Linux-x64.AppImage) |
          | **Linux** | x64 (Debian) | [Download .deb](${REPO_URL}/releases/download/${TAG_NAME}/FinceptTerminal-v${VERSION}-Linux-x64.deb) |
          | **Windows** | x64 | [Download .msi](${REPO_URL}/releases/download/${TAG_NAME}/FinceptTerminal-v${VERSION}-Windows-x64.msi) |

          > **One-Click Downloads** - These links will start downloading immediately - no GitHub login required.
          >
          > **Auto-Updates Enabled** - The app will automatically notify you of future updates.

          ### Build Status & Info

          ![Build Status](https://github.com/${{ github.repository }}/actions/workflows/release-production.yml/badge.svg)
          ![Latest Release](https://img.shields.io/github/v/release/${{ github.repository }}?label=Latest%20Release)
          ![Downloads](https://img.shields.io/github/downloads/${{ github.repository }}/total?label=Total%20Downloads)

          **Release Page:** [View all releases and changelogs](${REPO_URL}/releases)

          ---
          EOF

      - name: Update README files
        run: |
          # Function to update a README file
          update_readme() {
            local README_PATH="$1"

            if [ ! -f "$README_PATH" ]; then
              echo "[WARN] README not found: $README_PATH"
              return
            fi

            # Update or add download section
            if grep -q "<!-- DOWNLOAD_SECTION_START -->" "$README_PATH" && grep -q "<!-- DOWNLOAD_SECTION_END -->" "$README_PATH"; then
              echo "[INFO] Updating existing download section in $README_PATH..."
              awk '
                /<!-- DOWNLOAD_SECTION_START -->/ {
                  print $0
                  print ""
                  system("cat download_section.md")
                  while (getline > 0 && !/<!-- DOWNLOAD_SECTION_END -->/) continue
                  print "<!-- DOWNLOAD_SECTION_END -->"
                  next
                }
                { print }
              ' "$README_PATH" > temp_readme.md
              mv temp_readme.md "$README_PATH"
            else
              echo "[INFO] Adding new download section to $README_PATH..."
              if grep -q "^# " "$README_PATH"; then
                awk '
                  /^# / && !inserted {
                    print $0
                    print ""
                    print "<!-- DOWNLOAD_SECTION_START -->"
                    print ""
                    system("cat download_section.md")
                    print ""
                    print "<!-- DOWNLOAD_SECTION_END -->"
                    print ""
                    inserted = 1
                    next
                  }
                  { print }
                ' "$README_PATH" > temp_readme.md
                mv temp_readme.md "$README_PATH"
              fi
            fi
          }

          # Update both README files
          update_readme "README.md"
          update_readme "fincept-terminal-desktop/README.md"

          rm -f download_section.md

      - name: Commit and push README changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          # Add both README files
          git add README.md fincept-terminal-desktop/README.md 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "[INFO] No changes to commit"
          else
            git commit -m "Auto-update download links for ${{ steps.create_release.outputs.tag_name }}

            Updated direct download links for:
            - macOS (ARM64 & x64)
            - Linux (AppImage & .deb)
            - Windows (x64)

            Release: ${{ steps.create_release.outputs.tag_name }}
            All downloads are one-click with no GitHub login required"

            # Push with retries
            for i in {1..5}; do
              if git push; then
                echo "[OK] Successfully pushed README updates"
                break
              else
                echo "[WARN] Push failed, attempt $i/5"
                if [ $i -lt 5 ]; then
                  echo "[INFO] Pulling latest changes and retrying..."
                  git pull --rebase origin main
                  sleep $((i * 2))
                else
                  echo "[ERROR] Failed to push README after 5 attempts"
                  exit 1
                fi
              fi
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
